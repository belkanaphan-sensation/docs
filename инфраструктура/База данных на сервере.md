# База данных на сервере

Пошаговая инструкция для **установки PostgreSQL 15 на домашнем сервере** для тестового k3s-кластера с возможностью работы через SSH с рабочего компьютера.

---

## 1. Создание каталогов для данных и бэкапов

На сервере создаём необходимые директории:

```bash
mkdir -p ~/postgres/data
mkdir -p ~/postgres/backups
```

**Назначение каталогов:**
- `~/postgres/data` → хранение данных PostgreSQL (volume)
- `~/postgres/backups` → хранение дампов для резервного копирования

---

## 2. Создание `docker-compose.yml`

В папке `~/postgres` создаём файл `docker-compose.yml`:

```yaml
version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: sensation-postgres
    restart: unless-stopped
    ports:
      - "9432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: sensation
    volumes:
      - ./data:/var/lib/postgresql/data
      - ./backups:/backups

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: adminpassword
    ports:
      - "9433:80"
```

---

## 3. Запуск PostgreSQL и PgAdmin

На сервере выполняем:

```bash
cd ~/postgres
docker compose up -d
```

**Проверка работы контейнеров:**

```bash
docker ps
```

**Доступные сервисы:**
- PostgreSQL: порт `9432`
- PgAdmin: `http://<IP_сервера>:9433`

---

## 4. Создание бэкапа базы данных

Для создания дампа всей базы данных:

```bash
docker exec -t sensation-postgres pg_dumpall -U postgres > ~/postgres/backups/full_backup.sql
```

**Примечание:** Файл `full_backup.sql` можно скачать на рабочий компьютер через `scp`.

---

## 5. Восстановление из бэкапа

Для восстановления базы данных из бэкапа:

```bash
cat ~/postgres/backups/full_backup.sql | docker exec -i sensation-postgres psql -U postgres
```

---

## 6. Настройка безопасности (для домашнего сервера)

Для ограничения доступа к PostgreSQL через firewall:

```bash
sudo ufw allow from <IP_твоего_рабочего_компа> to any port 9432
sudo ufw deny 9432
```

---

## 7. Подключение к PostgreSQL

Ты пробросила порт 5432 контейнера на **9432** хоста:

```yaml
ports:
  - "9432:5432"
```

### 7.1 Через psql на сервере

Если на сервере установлен `psql`:

```bash
psql -h localhost -p 9432 -U postgres -d sensation
```

**Параметры подключения:**
- `-h localhost` → хост контейнера (локальный сервер)
- `-p 9432` → порт на сервере, проброшенный на контейнер
- `-U postgres` → пользователь
- `-d sensation` → база данных

**Пароль:** `postgres`

### 7.2 Через psql с рабочего компьютера

Для подключения с рабочей машины:

```bash
psql -h <IP_сервера> -p 9432 -U postgres -d sensation
```

**SSH-туннель (рекомендуется для домашнего интернета):**

```bash
ssh -L 5432:localhost:9432 user@<IP_сервера>
psql -h localhost -p 5432 -U postgres -d sensation
```

---

## 8. Подключение к PgAdmin

### 8.1 Веб-интерфейс

```yaml
ports:
  - "9433:80"
```

Откройте браузер на рабочем компьютере:

```
http://<IP_сервера>:9433
```

**Данные для входа:**
- **Email:** `admin@example.com`
- **Пароль:** `adminpassword`

### 8.2 Настройка подключения к PostgreSQL в PgAdmin

После входа в PgAdmin добавьте сервер PostgreSQL:

**Для подключения из PgAdmin (т.к. PgAdmin работает внутри контейнера):**
- **Host name/address:** `postgres` (имя сервиса из docker-compose)
- **Port:** `5432` (внутренний порт контейнера)
- **Maintenance database:** `sensation`
- **Username:** `postgres`
- **Password:** `postgres`

**Для подключения с рабочего компьютера:**
- **Host name/address:** `<IP_сервера>` или `localhost` (при SSH-туннеле)
- **Port:** `9432` (внешний порт) или `5432` (при SSH-туннеле)
- **Maintenance database:** `sensation`
- **Username:** `postgres`
- **Password:** `postgres`
